<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - AI Query Bot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
  <style>
    :root {
      --primary-color: #7c3aed;
      --secondary-color: #4b5563;
      --accent-color: #10b981;
      --bg-color: #111827;
      --card-bg: #1f2937;
      --text-color: #f3f4f6;
      --border-radius: 12px;
      --gradient-start: #1a1a2e;
      --gradient-end: #16213e;
      --sidebar-width: 250px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
    }

    .admin-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar styles */
    .sidebar {
      width: var(--sidebar-width);
      background-color: rgba(31, 41, 55, 0.8);
      backdrop-filter: blur(10px);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
      z-index: 1000;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }

    .admin-logo {
      background: linear-gradient(135deg, var(--primary-color), #6d28d9);
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
    }

    .admin-logo i {
      font-size: 1.5rem;
      color: white;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 1.2rem;
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }

    .nav-item {
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-color);
      text-decoration: none;
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }

    .nav-item:hover, .nav-item.active {
      background-color: rgba(255, 255, 255, 0.1);
      border-left-color: var(--primary-color);
    }

    .nav-item i {
      font-size: 1.2rem;
      min-width: 24px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      width: 100%;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    /* Main content styles */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: margin-left 0.3s ease;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .user-welcome {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), #6d28d9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .username {
      font-weight: 600;
    }
    
    /* Tab navigation */
    .content-tabs {
      display: flex;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 30px;
    }
    
    .tab-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
    }
    
    .tab-item:hover {
      color: var(--primary-color);
    }
    
    .tab-item.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    
    /* Tab content */
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Stats cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .stat-title {
      font-size: 0.9rem;
      opacity: 0.8;
    }

    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .icon-purple {
      background-color: rgba(124, 58, 237, 0.2);
      color: #7c3aed;
    }

    .icon-blue {
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .icon-green {
      background-color: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .icon-red {
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-description {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    /* Chart containers */
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .chart-title {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Loading spinner */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Users table */
    .data-table-container {
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow-x: auto;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .data-table th {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      background-color: rgba(0, 0, 0, 0.2);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .table-actions {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      opacity: 0.8;
      transition: all 0.2s;
      padding: 5px;
    }

    .action-btn:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .action-btn.view {
      color: #3b82f6;
    }

    .action-btn.edit {
      color: #10b981;
    }

    .action-btn.delete {
      color: #ef4444;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status-badge.admin {
      background-color: rgba(124, 58, 237, 0.2);
      color: #7c3aed;
    }

    .status-badge.user {
      background-color: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1500;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-backdrop.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-container {
      width: 90%;
      max-width: 500px;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
      padding: 24px;
      transform: scale(0.95);
      transition: transform 0.3s;
    }

    .modal-backdrop.active .modal-container {
      transform: scale(1);
    }

    .modal-header {
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .close-modal {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.5rem;
      opacity: 0.7;
      cursor: pointer;
    }

    .close-modal:hover {
      opacity: 1;
    }

    .modal-content {
      margin-bottom: 24px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 16px;
      border-radius: var(--border-radius);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .modal-btn-cancel {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .modal-btn-cancel:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .modal-btn-danger {
      background-color: #ef4444;
      color: white;
    }

    .modal-btn-danger:hover {
      background-color: #dc2626;
    }

    .modal-btn-success {
      background-color: #10b981;
      color: white;
    }

    .modal-btn-success:hover {
      background-color: #059669;
    }

    .user-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .user-detail-item {
      margin-bottom: 10px;
    }

    .user-detail-label {
      font-size: 0.9rem;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .user-detail-value {
      font-weight: 500;
    }

    .user-chats {
      margin-top: 20px;
    }

    .user-chats-header {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      opacity: 0.7;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .empty-state-subtext {
      font-size: 0.9rem;
    }

    /* Add these styles to the existing style section */
    .notification-area {
      position: fixed;
      right: 0;
      top: 0;
      width: 300px;
      height: 100vh;
      background-color: var(--card-bg);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .notification-area.active {
      transform: translateX(0);
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .notification-title {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .notification-count {
      background-color: var(--primary-color);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .notification-item {
      background-color: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .notification-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .notification-query {
      font-weight: 500;
      margin-bottom: 10px;
      color: var(--text-color);
    }

    .notification-response {
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.9rem;
    }

    .notification-time {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 8px;
    }

    .notification-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .notification-btn {
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .notification-btn.view {
      background-color: var(--primary-color);
      color: white;
    }

    .notification-btn.dismiss {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--text-color);
    }

    .notification-btn:hover {
      opacity: 0.9;
    }

    .chat-container {
      transition: margin-right 0.3s ease;
    }

    .chat-container.notification-active {
      margin-right: 300px;
    }

    .notification-toggle {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 50px;
      height: 50px;
      background-color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .notification-toggle i {
      color: white;
      font-size: 1.2rem;
    }

    .notification-toggle .badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background-color: #ef4444;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <div class="admin-logo">
          <i class="fas fa-user-shield"></i>
        </div>
        <div class="sidebar-title">Admin Panel</div>
      </div>
      <div class="sidebar-nav">
        <a href="#dashboard" class="nav-item active" data-tab="dashboard">
          <i class="fas fa-tachometer-alt"></i>
          <span>Dashboard</span>
        </a>
        <a href="#users" class="nav-item" data-tab="users">
          <i class="fas fa-users"></i>
          <span>User Management</span>
        </a>
        <a href="#chats" class="nav-item" data-tab="chats">
          <i class="fas fa-comments"></i>
          <span>Chat Logs</span>
          <span id="chats-notification-badge" class="notification-badge">0</span>
        </a>
        <a href="#settings" class="nav-item" data-tab="settings">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
        </a>
        <a href="#undefined-queries" class="nav-item" data-tab="undefined-queries">
          <i class="fas fa-question-circle"></i>
          <span>Undefined Queries</span>
          <span id="sidebar-notification-badge" class="badge bg-danger rounded-pill ms-2" style="display: none;">0</span>
        </a>
        <a href="#stored-responses" class="nav-item" data-tab="stored-responses">
          <i class="fas fa-database"></i>
          <span>Stored Responses</span>
        </a>
      </div>
      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="admin-header">
        <h1 class="page-title" id="currentPageTitle">Dashboard</h1>
        <div class="user-welcome">
          <div class="user-avatar" id="userAvatarInitial">A</div>
          <div>
            Welcome, <span class="username" id="usernameDisplay">Admin</span>
          </div>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="content-tabs">
        <div class="tab-item active" data-tab="dashboard">Dashboard</div>
        <div class="tab-item" data-tab="users">User Management</div>
        <div class="tab-item" data-tab="chats">Chat Logs</div>
        <div class="tab-item" data-tab="settings">Settings</div>
        <div class="tab-item" data-tab="undefined-queries">
          <i class="fas fa-question-circle"></i> Undefined Queries
        </div>
        <div class="tab-item" data-tab="stored-responses">Stored Responses</div>
      </div>
      
      <!-- Tab Contents -->
      <div id="dashboardTab" class="tab-content active">
        <div class="row">
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card">
              <div class="stat-card-content">
                <div class="stat-card-info">
                  <div class="stat-card-title">Total Users</div>
                  <div class="stat-card-value" id="totalUsersCount">0</div>
                </div>
                <div class="stat-card-icon">
                  <i class="fas fa-users"></i>
                </div>
              </div>
              <div class="stat-card-actions">
                <a href="#" class="stat-card-link" id="viewUsersLink">View All Users</a>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card">
              <div class="stat-card-content">
                <div class="stat-card-info">
                  <div class="stat-card-title">Total Chats</div>
                  <div class="stat-card-value" id="totalChats">-</div>
                </div>
                <div class="stat-card-icon">
                  <i class="fas fa-comments"></i>
                </div>
              </div>
              <div class="stat-card-actions">
                <a href="#" class="stat-card-link" id="viewChatsLink">View All Chats</a>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card">
              <div class="stat-card-content">
                <div class="stat-card-info">
                  <div class="stat-card-title">Total Messages</div>
                  <div class="stat-card-value" id="totalMessages">-</div>
                </div>
                <div class="stat-card-icon">
                  <i class="fas fa-envelope"></i>
                </div>
              </div>
              <div class="stat-card-actions">
                <a href="#" class="stat-card-link" id="viewMessagesLink">View All Messages</a>
              </div>
            </div>
          </div>
          
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="stat-card">
              <div class="stat-card-content">
                <div class="stat-card-info">
                  <div class="stat-card-title">New Users (7 days)</div>
                  <div class="stat-card-value" id="newUsers">-</div>
                </div>
                <div class="stat-card-icon">
                  <i class="fas fa-user-plus"></i>
                </div>
              </div>
              <div class="stat-card-actions">
                <a href="#" class="stat-card-link" id="viewNewUsersLink">View New Users</a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Messages per Day</div>
            </div>
            <div class="chart-container">
              <canvas id="messagesChart"></canvas>
            </div>
          </div>
          
          <div class="chart-card">
            <div class="chart-header">
              <div class="chart-title">Message Distribution</div>
            </div>
            <div class="chart-container">
              <canvas id="messageDistributionChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      
      <div id="usersTab" class="tab-content">
        <div class="data-table-container">
          <table class="data-table" id="usersTable">
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Created At</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="5">
                  <div class="loading-spinner">
                    <div class="spinner"></div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- User Details Modal -->
      <div id="userDetailsModal" class="modal-backdrop">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">User Details</h3>
            <button class="close-modal" id="closeUserDetails">&times;</button>
          </div>
          <div class="modal-content">
            <div class="user-details" id="userDetailsContent">
              <div class="user-detail-item">
                <div class="user-detail-label">Username</div>
                <div class="user-detail-value" id="detailUsername">-</div>
              </div>
              <div class="user-detail-item">
                <div class="user-detail-label">Email</div>
                <div class="user-detail-value" id="detailEmail">-</div>
              </div>
              <div class="user-detail-item">
                <div class="user-detail-label">Role</div>
                <div class="user-detail-value" id="detailRole">-</div>
              </div>
              <div class="user-detail-item">
                <div class="user-detail-label">Created</div>
                <div class="user-detail-value" id="detailCreated">-</div>
              </div>
            </div>
            
            <div class="user-chats">
              <div class="user-chats-header">Chat History</div>
              <table class="data-table" id="userChatsTable">
                <thead>
                  <tr>
                    <th>Chat Name</th>
                    <th>Messages</th>
                    <th>Last Updated</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="userChatsTableBody">
                  <tr>
                    <td colspan="4">Loading chats...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" id="userDetailsDone">Close</button>
          </div>
        </div>
      </div>
      
      <!-- Delete User Modal -->
      <div id="deleteUserModal" class="modal-backdrop">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title">Delete User</h3>
            <button class="close-modal" id="closeDeleteUser">&times;</button>
          </div>
          <div class="modal-content">
            <p>Are you sure you want to delete the user <strong id="deleteUsername">username</strong>?</p>
            <p>This action cannot be undone. All of the user's chats and message history will be permanently deleted.</p>
          </div>
          <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" id="cancelDeleteUser">Cancel</button>
            <button class="modal-btn modal-btn-danger" id="confirmDeleteUser">Delete User</button>
          </div>
        </div>
      </div>
      
      <!-- Toggle Admin Modal -->
      <div id="toggleAdminModal" class="modal-backdrop">
        <div class="modal-container">
          <div class="modal-header">
            <h3 class="modal-title" id="toggleAdminTitle">Change User Role</h3>
            <button class="close-modal" id="closeToggleAdmin">&times;</button>
          </div>
          <div class="modal-content">
            <p id="toggleAdminMessage">Are you sure you want to change the role?</p>
          </div>
          <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" id="cancelToggleAdmin">Cancel</button>
            <button class="modal-btn modal-btn-success" id="confirmToggleAdmin">Change Role</button>
          </div>
        </div>
      </div>
      
      <div id="chatsTab" class="tab-content">
        <!-- Chat logs content will go here -->
        <h2>Chat Logs Loading...</h2>
      </div>
      
      <div id="settingsTab" class="tab-content">
        <!-- Settings content will go here -->
        <h2 class="mb-4">Admin Dashboard Settings</h2>
        
        <div class="row">
          <div class="col-md-6">
            <div class="card bg-dark mb-4">
              <div class="card-header">
                <h5 class="mb-0">General Settings</h5>
              </div>
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label for="siteName" class="form-label">Site Name</label>
                    <input type="text" class="form-control bg-dark text-light border-secondary" id="siteName" value="AI Query Bot">
                  </div>
                  
                  <div class="mb-3">
                    <label for="adminEmail" class="form-label">Admin Email</label>
                    <input type="email" class="form-control bg-dark text-light border-secondary" id="adminEmail" value="admin@example.com">
                  </div>
                  
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="enableNotifications" checked>
                    <label class="form-check-label" for="enableNotifications">Enable Email Notifications</label>
                  </div>
                  
                  <button type="button" class="btn btn-primary" disabled>Save Settings</button>
                  <small class="d-block mt-2 text-muted">Settings are in development mode</small>
                </form>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card bg-dark mb-4">
              <div class="card-header">
                <h5 class="mb-0">API Settings</h5>
              </div>
              <div class="card-body">
                <form>
                  <div class="mb-3">
                    <label for="apiKey" class="form-label">API Key</label>
                    <div class="input-group">
                      <input type="password" class="form-control bg-dark text-light border-secondary" id="apiKey" value="sk_test_123456789">
                      <button class="btn btn-outline-secondary" type="button" disabled>Show</button>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="apiModel" class="form-label">Default AI Model</label>
                    <select class="form-select bg-dark text-light border-secondary" id="apiModel">
                      <option selected>GPT-4</option>
                      <option>GPT-3.5</option>
                      <option>Claude</option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="maxTokens" class="form-label">Max Tokens: <span id="tokenValue">2048</span></label>
                    <input type="range" class="form-range" min="256" max="4096" step="128" id="maxTokens" value="2048">
                  </div>
                  
                  <button type="button" class="btn btn-primary" disabled>Update API Settings</button>
                  <small class="d-block mt-2 text-muted">API settings are in development mode</small>
                </form>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card bg-dark mb-4">
          <div class="card-header">
            <h5 class="mb-0">System Maintenance</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="d-grid">
                  <button type="button" class="btn btn-outline-primary" disabled>
                    <i class="fas fa-database me-2"></i>
                    Backup Database
                  </button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="d-grid">
                  <button type="button" class="btn btn-outline-warning" disabled>
                    <i class="fas fa-broom me-2"></i>
                    Clear Cache
                  </button>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="d-grid">
                  <button type="button" class="btn btn-outline-danger" disabled>
                    <i class="fas fa-trash me-2"></i>
                    Clear All Data
                  </button>
                </div>
              </div>
            </div>
            <small class="text-muted">Maintenance functions are disabled in development mode</small>
          </div>
        </div>
      </div>

      <!-- Undefined Queries Tab -->
      <div id="undefined-queries-content" class="tab-content">
        <div class="d-flex justify-content-between mb-4">
          <div class="btn-group">
            <button id="filter-pending" class="btn btn-primary active">Pending</button>
            <button id="filter-approved" class="btn btn-outline-primary">Approved</button>
            <button id="filter-rejected" class="btn btn-outline-primary">Rejected</button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-dark table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Query</th>
                <th>User</th>
                <th>Date</th>
                <th>AI Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="undefined-queries-table">
              <tr>
                <td colspan="6" class="text-center">Loading queries...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Stored Responses Tab -->
      <div id="stored-responsesTab" class="tab-content">
        <div class="d-flex justify-content-between mb-4">
          <h3>Stored Responses</h3>
          <div class="btn-group">
            <button id="view-custom-responses" class="btn btn-primary active">Custom Responses</button>
            <button id="view-academic-calendar" class="btn btn-outline-primary">Academic Calendar</button>
          </div>
        </div>
        
        <!-- Custom Responses Table -->
        <div id="custom-responses-container">
          <div class="card bg-dark mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Custom Responses</h5>
              <span class="badge bg-primary" id="custom-responses-count">0</span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-dark table-hover">
                  <thead>
                    <tr>
                      <th>Query</th>
                      <th>Response</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="custom-responses-table">
                    <tr>
                      <td colspan="3" class="text-center">Loading custom responses...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Academic Calendar Table -->
        <div id="academic-calendar-container" style="display: none;">
          <div class="card bg-dark mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Academic Calendar Entries</h5>
              <span class="badge bg-primary" id="academic-calendar-count">0</span>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-dark table-hover">
                  <thead>
                    <tr>
                      <th>S.No</th>
                      <th>Activity</th>
                      <th>Date</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="academic-calendar-table">
                    <tr>
                      <td colspan="4" class="text-center">Loading academic calendar entries...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Query Response Modal -->
      <div class="modal fade" id="queryResponseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content bg-dark text-light">
            <div class="modal-header">
              <h5 class="modal-title">Respond to Query</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="currentQueryId">
              
              <div class="mb-4">
                <h6 class="fw-bold">Query</h6>
                <div class="query-display p-3 bg-dark rounded" id="queryText"></div>
              </div>

              <div class="mb-4">
                <label for="queryResponse" class="form-label fw-bold">Response</label>
                <textarea 
                  id="queryResponse" 
                  class="form-control bg-dark text-light border-secondary" 
                  rows="6"
                  placeholder="Enter an official response to this query..."
                ></textarea>
                <small class="text-muted">Markdown formatting is supported</small>
              </div>

              <div class="mb-4">
                <h6 class="fw-bold">AI Analysis</h6>
                <div class="ai-analysis p-3 bg-dark rounded mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Data found in index:</span>
                    <span class="badge" id="aiDataStatus">Not analyzed</span>
                  </div>
                  <div id="aiAnalysisDetails" class="small text-muted">
                    No AI analysis information available
                  </div>
                </div>
                
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="runAiAnalysis">
                  <label class="form-check-label" for="runAiAnalysis">
                    Run AI analysis on save
                  </label>
                </div>
              </div>

              <div class="mb-3">
                <h6 class="fw-bold">Status</h6>
                <div class="status-options">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="queryStatus" id="statusPending" value="pending" checked>
                    <label class="form-check-label" for="statusPending">
                      <span class="badge bg-warning text-dark">Pending</span>
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="queryStatus" id="statusApproved" value="approved">
                    <label class="form-check-label" for="statusApproved">
                      <span class="badge bg-success">Approved</span>
                    </label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="queryStatus" id="statusRejected" value="rejected">
                    <label class="form-check-label" for="statusRejected">
                      <span class="badge bg-danger">Rejected</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" id="saveQueryResponse">Save Response</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container for notifications -->
  <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>
  
  <!-- Bootstrap JS and Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  
  <!-- Add module script to use the database.js functions -->
  <script type="module">
    import { getUndefinedQueries, updateUndefinedQuery, getStoredResponses, markQueryAsViewed } from '/js/database.js';
    
    // Function to show toast notification
    function showNewQueryNotification(queryData) {
      const toastContainer = document.getElementById('toast-container');
      const toastId = `toast-${Date.now()}`;
      
      const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header bg-primary text-white">
            <i class="fas fa-bell me-2"></i>
            <strong class="me-auto">New Query Received</strong>
            <small>${new Date().toLocaleTimeString()}</small>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body bg-dark text-light">
            A new query has been received from ${queryData.username || 'Anonymous'}
            <div class="mt-2">
              <button class="btn btn-sm btn-primary view-query" data-query-id="${queryData.id}">
                View Query
              </button>
            </div>
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHtml);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: false
      });
      
      // Add click handler for view button
      toastElement.querySelector('.view-query').addEventListener('click', () => {
        // Switch to undefined queries tab
        activateTab('undefined-queries');
        // Close the toast
        toast.hide();
      });
      
      toast.show();
    }

    // Function to check for new queries
    async function checkNewQueries() {
      try {
        const response = await fetch('/api/admin/new-queries');
        const data = await response.json();
        
        if (data.newQueries && data.newQueries.length > 0) {
          // Update notification badges
          const notificationBadge = document.getElementById('notification-badge');
          const sidebarNotificationBadge = document.getElementById('sidebar-notification-badge');
          
          if (notificationBadge) {
            notificationBadge.textContent = data.newQueries.length;
            notificationBadge.style.display = 'inline-block';
          }
          
          if (sidebarNotificationBadge) {
            sidebarNotificationBadge.textContent = data.newQueries.length;
            sidebarNotificationBadge.style.display = 'inline-block';
          }
          
          // Show toast notification for each new query
          data.newQueries.forEach(query => {
            showNewQueryNotification(query);
          });
          
          // Play notification sound
          const audio = new Audio('/sounds/notification.mp3');
          audio.play().catch(e => console.log('Error playing notification sound:', e));
        }
      } catch (error) {
        console.error('Error checking for new queries:', error);
      }
    }

    // Start periodic check for new queries
    setInterval(checkNewQueries, 30000); // Check every 30 seconds
    
    // Initial check for new queries
    document.addEventListener('DOMContentLoaded', () => {
      checkNewQueries();
    });
    
    // Make functions available to window context for use in other scripts
    window.loadUndefinedQueriesFromModule = async function(status = 'pending') {
      console.log(`Loading undefined queries with status: ${status}`);
      const tableBody = document.getElementById('undefined-queries-table');
      
      if (!tableBody) {
        console.error('undefined-queries-table element not found');
        return;
      }
      
      tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';
      
      // Update filter buttons
      document.querySelectorAll('#filter-pending, #filter-approved, #filter-rejected').forEach(btn => {
        btn.classList.remove('btn-primary', 'active', 'btn-outline-primary');
        btn.classList.add('btn-outline-primary');
      });
      
      const activeFilter = document.getElementById(`filter-${status}`);
      if (activeFilter) {
        activeFilter.classList.remove('btn-outline-primary');
        activeFilter.classList.add('btn-primary', 'active');
      } else {
        console.warn(`Filter button for status '${status}' not found`);
      }
      
      try {
        console.log('Fetching undefined queries data...');
        const data = await getUndefinedQueries(status);
        console.log('Received data:', data);
        
        if (data.queries && data.queries.length > 0) {
          console.log(`Found ${data.queries.length} queries`);
          tableBody.innerHTML = '';
          
          data.queries.forEach(query => {
            // Check if this is a new unread query
            const isNew = !query.viewed_by_admin;
            
            const row = document.createElement('tr');
            if (isNew) {
              row.className = 'table-warning'; // Highlight new queries
            }
            
            // ID cell
            const idCell = document.createElement('td');
            idCell.textContent = query.id;
            row.appendChild(idCell);
            
            // Query cell (truncated)
            const queryCell = document.createElement('td');
            const queryText = query.query.length > 50 ? 
              query.query.substring(0, 50) + '...' : 
              query.query;
            queryCell.textContent = queryText;
            
            // Add new badge for unread items
            if (isNew) {
              const badge = document.createElement('span');
              badge.className = 'badge bg-danger ms-2';
              badge.textContent = 'New';
              queryCell.appendChild(badge);
            }
            
            row.appendChild(queryCell);
            
            // User cell
            const userCell = document.createElement('td');
            userCell.textContent = query.username || 'Anonymous';
            row.appendChild(userCell);
            
            // Date cell
            const dateCell = document.createElement('td');
            dateCell.textContent = new Date(query.created_at).toLocaleString();
            row.appendChild(dateCell);
            
            // AI Status cell
            const aiStatusCell = document.createElement('td');
            if (query.ai_analyzed) {
              const aiStatusBadge = document.createElement('span');
              if (query.ai_data_found) {
                aiStatusBadge.className = 'badge bg-success';
                aiStatusBadge.textContent = 'Data Found';
              } else {
                aiStatusBadge.className = 'badge bg-danger';
                aiStatusBadge.textContent = 'No Data';
              }
              aiStatusCell.appendChild(aiStatusBadge);
            } else {
              const aiStatusBadge = document.createElement('span');
              aiStatusBadge.className = 'badge bg-secondary';
              aiStatusBadge.textContent = 'Not Analyzed';
              aiStatusCell.appendChild(aiStatusBadge);
            }
            row.appendChild(aiStatusCell);
            
            // Actions cell
            const actionsCell = document.createElement('td');
            
            const respondBtn = document.createElement('button');
            respondBtn.className = 'btn btn-sm btn-primary respond-btn me-2';
            respondBtn.innerHTML = '<i class="fas fa-reply"></i> Respond';
            respondBtn.setAttribute('data-query-id', query.id);
            actionsCell.appendChild(respondBtn);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-danger delete-query-btn';
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
            deleteBtn.setAttribute('data-query-id', query.id);
            actionsCell.appendChild(deleteBtn);
            
            row.appendChild(actionsCell);
            
            tableBody.appendChild(row);
          });
          
          // Add event listeners to response buttons
          document.querySelectorAll('.respond-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const queryId = this.getAttribute('data-query-id');
              openQueryResponseModal(queryId, data.queries);
            });
          });
          
          // Add event listeners to delete buttons
          document.querySelectorAll('.delete-query-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const queryId = this.getAttribute('data-query-id');
              if (confirm('Are you sure you want to delete this query? This action cannot be undone.')) {
                deleteUndefinedQuery(queryId)
                  .then(result => {
                    if (result.success) {
                      // Remove row from table
                      this.closest('tr').remove();
                      alert('Query deleted successfully');
                    } else {
                      throw new Error(result.message || 'Failed to delete query');
                    }
                  })
                  .catch(error => {
                    console.error('Error deleting query:', error);
                    alert(`Error: ${error.message}`);
                  });
              }
            });
          });
          
          console.log('Undefined queries table populated successfully');
        } else {
          console.log('No queries found for status:', status);
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No queries found</td></tr>';
        }
      } catch (error) {
        console.error('Error loading undefined queries:', error);
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">
          Error loading queries: ${error.message}
        </td></tr>`;
      }
    };
    
    // Set up the save button handler
    function setupSaveButton() {
      const saveBtn = document.getElementById('saveQueryResponse');
      if (!saveBtn) {
        console.error('Save query response button not found');
        return;
      }
      
      console.log('Setting up save query response button handler');
      
      // Replace existing event listeners by cloning
      const newSaveBtn = saveBtn.cloneNode(true);
      saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
      
      // Add our event listener
      newSaveBtn.addEventListener('click', async function(event) {
        console.log('Save query response button clicked (from module)');
        
        const queryId = document.getElementById('currentQueryId').value;
        const response = document.getElementById('queryResponse').value;
        const statusElement = document.querySelector('input[name="queryStatus"]:checked');
        const status = statusElement ? statusElement.value : 'pending';
        const runAiAnalysis = document.getElementById('runAiAnalysis').checked;
        
        if (status === 'approved' && !response.trim()) {
          alert('Please enter a response before approving.');
          return;
        }
        
        try {
          // Show loading state
          this.disabled = true;
          this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
          
          console.log(`Saving query response for ID ${queryId}...`);
          const result = await updateUndefinedQuery(queryId, {
            status,
            response: response.trim(),
            runAiAnalysis
          });
          console.log('Save result:', result);
          
          // Hide the modal
          const modalElement = document.getElementById('queryResponseModal');
          if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
              modal.hide();
            } else {
              console.warn('Bootstrap modal instance not found');
              modalElement.classList.remove('show');
              modalElement.style.display = 'none';
              document.body.classList.remove('modal-open');
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) backdrop.remove();
            }
          } else {
            console.warn('Modal element not found');
          }
          
          // Reload the queries to reflect changes
          window.loadUndefinedQueries(status);
          
          // Refresh the notification count
          fetchNotificationCount();
          
          // Show success message
          alert('Query response saved successfully!');
        } catch (error) {
          console.error('Error saving query response:', error);
          alert(`Error saving response: ${error.message}`);
        } finally {
          // Reset button state
          this.disabled = false;
          this.innerHTML = '<i class="fas fa-save"></i> Save Response';
        }
      });
      
      console.log('Save button handler setup complete');
    }
    
    // Function to load stored responses
    window.loadStoredResponsesFromModule = async function() {
      try {
        console.log('Loading stored responses...');
        const data = await getStoredResponses();
        
        // Update custom responses table
        const customResponsesTable = document.getElementById('custom-responses-table');
        const customResponsesCount = document.getElementById('custom-responses-count');
        
        if (customResponsesTable && data.customResponses && data.customResponses.responses) {
          const responses = data.customResponses.responses;
          customResponsesTable.innerHTML = '';
          
          // Update count
          if (customResponsesCount) {
            customResponsesCount.textContent = data.totalCustomResponses;
          }
          
          if (Object.keys(responses).length > 0) {
            for (const query in responses) {
              const row = document.createElement('tr');
              
              // Query cell
              const queryCell = document.createElement('td');
              queryCell.textContent = query;
              row.appendChild(queryCell);
              
              // Response cell
              const responseCell = document.createElement('td');
              responseCell.textContent = responses[query];
              row.appendChild(responseCell);
              
              // Actions cell
              const actionsCell = document.createElement('td');
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'action-btn delete';
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.title = 'Delete response';
              deleteBtn.setAttribute('data-query', query);
              deleteBtn.setAttribute('data-type', 'custom');
              
              deleteBtn.addEventListener('click', function() {
                const query = this.getAttribute('data-query');
                if (confirm(`Are you sure you want to delete the response for "${query}"?`)) {
                  deleteStoredResponse(query, 'custom')
                    .then(result => {
                      if (result.success) {
                        // Remove row from table
                        this.closest('tr').remove();
                        
                        // Update count
                        if (customResponsesCount) {
                          const count = parseInt(customResponsesCount.textContent) - 1;
                          customResponsesCount.textContent = count;
                        }
                        
                        alert('Response deleted successfully');
                      } else {
                        throw new Error(result.message || 'Failed to delete response');
                      }
                    })
                    .catch(error => {
                      console.error('Error deleting response:', error);
                      alert(`Error: ${error.message}`);
                    });
                }
              });
              
              actionsCell.appendChild(deleteBtn);
              row.appendChild(actionsCell);
              
              customResponsesTable.appendChild(row);
            }
          } else {
            customResponsesTable.innerHTML = '<tr><td colspan="3" class="text-center">No custom responses found</td></tr>';
          }
        }
        
        // Update academic calendar table
        const academicCalendarTable = document.getElementById('academic-calendar-table');
        const academicCalendarCount = document.getElementById('academic-calendar-count');
        
        if (academicCalendarTable && data.academicCalendarEntries) {
          const entries = data.academicCalendarEntries;
          academicCalendarTable.innerHTML = '';
          
          // Update count
          if (academicCalendarCount) {
            academicCalendarCount.textContent = data.totalAcademicCalendarEntries;
          }
          
          if (entries.length > 0) {
            entries.forEach(entry => {
              const row = document.createElement('tr');
              
              // S.No cell
              const snoCell = document.createElement('td');
              snoCell.textContent = entry["S.No"] || '';
              row.appendChild(snoCell);
              
              // Activity cell
              const activityCell = document.createElement('td');
              activityCell.textContent = entry.Activity || '';
              row.appendChild(activityCell);
              
              // Date cell
              const dateCell = document.createElement('td');
              dateCell.textContent = entry.Date || '';
              row.appendChild(dateCell);
              
              // Actions cell
              const actionsCell = document.createElement('td');
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'action-btn delete';
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.title = 'Delete entry';
              deleteBtn.setAttribute('data-sno', entry["S.No"] || '');
              
              deleteBtn.addEventListener('click', function() {
                const sno = this.getAttribute('data-sno');
                if (confirm(`Are you sure you want to delete the entry #${sno}?`)) {
                  deleteStoredResponse(sno, 'academic')
                    .then(result => {
                      if (result.success) {
                        // Remove row from table
                        this.closest('tr').remove();
                        
                        // Update count
                        if (academicCalendarCount) {
                          const count = parseInt(academicCalendarCount.textContent) - 1;
                          academicCalendarCount.textContent = count;
                        }
                        
                        alert('Entry deleted successfully');
                      } else {
                        throw new Error(result.message || 'Failed to delete entry');
                      }
                    })
                    .catch(error => {
                      console.error('Error deleting entry:', error);
                      alert(`Error: ${error.message}`);
                    });
                }
              });
              
              actionsCell.appendChild(deleteBtn);
              row.appendChild(actionsCell);
              
              academicCalendarTable.appendChild(row);
            });
          } else {
            academicCalendarTable.innerHTML = '<tr><td colspan="4" class="text-center">No academic calendar entries found</td></tr>';
          }
        }
        
        console.log('Stored responses loaded successfully');
      } catch (error) {
        console.error('Error loading stored responses:', error);
        
        const customResponsesTable = document.getElementById('custom-responses-table');
        if (customResponsesTable) {
          customResponsesTable.innerHTML = `<tr><td colspan="3" class="text-center text-danger">
            Error loading custom responses: ${error.message}
          </td></tr>`;
        }
        
        const academicCalendarTable = document.getElementById('academic-calendar-table');
        if (academicCalendarTable) {
          academicCalendarTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">
            Error loading academic calendar entries: ${error.message}
          </td></tr>`;
        }
      }
    };
    
    // Setup toggle between custom responses and academic calendar
    function setupStoredResponsesToggle() {
      const customResponsesBtn = document.getElementById('view-custom-responses');
      const academicCalendarBtn = document.getElementById('view-academic-calendar');
      const customResponsesContainer = document.getElementById('custom-responses-container');
      const academicCalendarContainer = document.getElementById('academic-calendar-container');
      
      if (customResponsesBtn && academicCalendarBtn && customResponsesContainer && academicCalendarContainer) {
        customResponsesBtn.addEventListener('click', function() {
          customResponsesBtn.classList.add('btn-primary', 'active');
          customResponsesBtn.classList.remove('btn-outline-primary');
          academicCalendarBtn.classList.add('btn-outline-primary');
          academicCalendarBtn.classList.remove('btn-primary', 'active');
          
          customResponsesContainer.style.display = 'block';
          academicCalendarContainer.style.display = 'none';
        });
        
        academicCalendarBtn.addEventListener('click', function() {
          academicCalendarBtn.classList.add('btn-primary', 'active');
          academicCalendarBtn.classList.remove('btn-outline-primary');
          customResponsesBtn.classList.add('btn-outline-primary');
          customResponsesBtn.classList.remove('btn-primary', 'active');
          
          academicCalendarContainer.style.display = 'block';
          customResponsesContainer.style.display = 'none';
        });
      }
    }
    
    // Define the missing openQueryResponseModal function
    window.openQueryResponseModal = async function(queryId, queries) {
      const query = queries.find(q => q.id == queryId);
      if (!query) return;
      
      // Mark the query as viewed by admin
      try {
        await markQueryAsViewed(queryId);
        
        // Remove the new badge and warning highlight from the table row
        const queryRow = document.querySelector(`tr[data-query-id="${queryId}"]`);
        if (queryRow) {
          queryRow.classList.remove('table-warning');
          const badge = queryRow.querySelector('.badge.bg-danger');
          if (badge) {
            badge.remove();
          }
        }
        
        // Update notification count
        checkNewQueries();
      } catch (error) {
        console.error('Error marking query as viewed:', error);
      }
      
      // Fill the modal with query details
      document.getElementById('currentQueryId').value = queryId;
      document.getElementById('queryText').textContent = query.query;
      document.getElementById('queryResponse').value = query.response || '';
      
      // Set the status radio button
      const statusElement = document.getElementById(`status${capitalizeFirstLetter(query.status)}`);
      if (statusElement) {
        statusElement.checked = true;
      } else {
        // Default to pending if status element not found
        const pendingStatus = document.getElementById('statusPending');
        if (pendingStatus) pendingStatus.checked = true;
      }
      
      // Set AI analysis info if available
      const aiDataStatus = document.getElementById('aiDataStatus');
      const aiAnalysisDetails = document.getElementById('aiAnalysisDetails');
      
      if (aiDataStatus && aiAnalysisDetails) {
        if (query.ai_analyzed) {
          if (query.ai_data_found) {
            aiDataStatus.textContent = 'Data Found';
            aiDataStatus.className = 'badge bg-success';
            
            try {
              const dataDetails = JSON.parse(query.ai_data_details || '{}');
              let detailsText = `Source: ${dataDetails.source || 'Unknown'}\n`;
              
              if (dataDetails.data && dataDetails.data.length > 0) {
                detailsText += `Found ${dataDetails.data.length} matching entries`;
              }
              
              aiAnalysisDetails.textContent = detailsText;
            } catch (e) {
              aiAnalysisDetails.textContent = 'Data found but details unavailable';
            }
          } else {
            aiDataStatus.textContent = 'No Data Found';
            aiDataStatus.className = 'badge bg-danger';
            aiAnalysisDetails.textContent = 'Query was analyzed but no relevant data was found in any index';
          }
        } else {
          aiDataStatus.textContent = 'Not Analyzed';
          aiDataStatus.className = 'badge bg-secondary';
          aiAnalysisDetails.textContent = 'This query has not been analyzed by AI yet';
        }
      }
      
      // Check the AI analysis checkbox by default
      const runAiAnalysis = document.getElementById('runAiAnalysis');
      if (runAiAnalysis) {
        runAiAnalysis.checked = !query.ai_analyzed;
      }
      
      // Show the modal
      const modalElement = document.getElementById('queryResponseModal');
      if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
      }
    };
    
    // Helper function for capitalizing first letter
    function capitalizeFirstLetter(string) {
      if (!string) return '';
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
    
    // Define the missing markNotificationsAsRead function
    window.markNotificationsAsRead = function() {
      console.log('Marking notifications as read...');
      fetch('/api/admin/mark-queries-notified', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to mark notifications as read');
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
              notificationBadge.style.display = 'none';
            }
            console.log('Notifications marked as read successfully');
          }
        })
        .catch(error => {
          console.error('Error marking notifications as read:', error);
        });
    };
    
    // Wait for document to load then replace original function with module version
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Setting up module functions for undefined queries...');
      // Make our module function available globally
      window.loadUndefinedQueries = window.loadUndefinedQueriesFromModule;
      window.loadStoredResponses = window.loadStoredResponsesFromModule;
      
      // Setup the save button
      setupSaveButton();
      
      // Setup stored responses toggle
      setupStoredResponsesToggle();
      
      // Fetch notification count
      fetchNotificationCount();
      
      // Wait a bit to ensure all DOM elements are available
      setTimeout(() => {
        // Verify that the undefined-queries-table exists
        const tableElement = document.getElementById('undefined-queries-table');
        if (tableElement) {
          console.log('Found undefined-queries-table, loading data...');
          window.loadUndefinedQueries('pending');
        } else {
          console.error('Cannot find undefined-queries-table element');
        }
      }, 500);
    });
  </script>

  <!-- Function to fetch notification count and update badge -->
  <script>
    // Fetch and update notification count
    function fetchNotificationCount() {
      console.log('Fetching notification count...');
      fetch('/api/admin/unnotified-queries-count')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch notification count');
          }
          return response.json();
        })
        .then(data => {
          const notificationBadge = document.getElementById('notification-badge');
          const sidebarNotificationBadge = document.getElementById('sidebar-notification-badge');
          
          // Update badges based on count
          if (data.count > 0) {
            // Update badges text
            const count = data.count;
            
            // Update main tab badge
            if (notificationBadge) {
              notificationBadge.textContent = count;
              notificationBadge.style.display = 'inline-block';
            }
            
            // Update sidebar badge
            if (sidebarNotificationBadge) {
              sidebarNotificationBadge.textContent = count;
              sidebarNotificationBadge.style.display = 'inline-block';
            }
            
            console.log(`Updated notification badges: ${count} unread notifications`);
          } else {
            // Hide badges when count is 0
            if (notificationBadge) {
              notificationBadge.style.display = 'none';
            }
            
            if (sidebarNotificationBadge) {
              sidebarNotificationBadge.style.display = 'none';
            }
            
            console.log('No unread notifications');
          }
        })
        .catch(error => {
          console.error('Error fetching notification count:', error);
        });
    }
  </script>

  <!-- Tab switching functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const tabItems = document.querySelectorAll('.tab-item');
      const navItems = document.querySelectorAll('.nav-item');
      
      // Set up logout button functionality
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async function() {
          if (confirm('Are you sure you want to logout?')) {
            try {
              // Show loading state
              logoutBtn.disabled = true;
              logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
              
              // Call the logout API
              const response = await fetch('/api/logout', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                credentials: 'include'
              });
              
              if (response.ok) {
                const data = await response.json();
                if (data.success) {
                  // Clear any local storage data
                  localStorage.removeItem('user');
                  sessionStorage.clear();
                  
                  // Redirect to login page
                  window.location.href = '/login.html';
                } else {
                  throw new Error(data.message || 'Logout failed');
                }
              } else {
                console.warn('Server-side logout may not have completed successfully');
                // Still redirect to login
                window.location.href = '/login.html';
              }
            } catch (error) {
              console.error('Error during logout:', error);
              alert('An error occurred during logout. Please try again.');
              
              // Reset button state
              logoutBtn.disabled = false;
              logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i><span>Logout</span>';
            }
          }
        });
      }
      
      // Initial fetch for notification count
      fetchNotificationCount();
      
      // Setup periodic check for new notifications (every 60 seconds)
      setInterval(fetchNotificationCount, 60000);
      
      // Initial load of dashboard data
      loadDashboard();
      
      // Setup click handlers for main tab items
      tabItems.forEach(tab => {
        tab.addEventListener('click', () => {
          activateTab(tab.getAttribute('data-tab'));
        });
      });
      
      // Setup click handlers for sidebar navigation items
      navItems.forEach(navItem => {
        navItem.addEventListener('click', (e) => {
          // Prevent default link behavior
          e.preventDefault();
          
          // Remove active class from all nav items
          navItems.forEach(item => item.classList.remove('active'));
          
          // Add active class to clicked nav item
          navItem.classList.add('active');
          
          // Get the tab ID from the data-tab attribute
          const tabId = navItem.getAttribute('data-tab');
          
          // Activate the corresponding tab
          activateTab(tabId);
        });
      });
      
      // Setup filter buttons for undefined queries
      document.getElementById('filter-pending')?.addEventListener('click', function() {
        loadUndefinedQueries('pending');
      });
      
      document.getElementById('filter-approved')?.addEventListener('click', function() {
        loadUndefinedQueries('approved');
      });
      
      document.getElementById('filter-rejected')?.addEventListener('click', function() {
        loadUndefinedQueries('rejected');
      });
      
      // Handle token range slider in settings
      const tokenSlider = document.getElementById('maxTokens');
      const tokenValue = document.getElementById('tokenValue');
      if (tokenSlider && tokenValue) {
        tokenSlider.addEventListener('input', function() {
          tokenValue.textContent = this.value;
        });
      }
      
      // Function to activate a tab by ID
      function activateTab(tabId) {
        console.log(`Activating tab: ${tabId}`);
        
        // Update tab items
        tabItems.forEach(item => {
          if (item.getAttribute('data-tab') === tabId) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });
        
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Handle special cases for tab content IDs
        let contentId;
        if (tabId === 'undefined-queries') {
          contentId = 'undefined-queries-content';
        } else if (tabId === 'stored-responses') {
          contentId = 'stored-responsesTab';
          // Load stored responses when tab is clicked
          if (typeof window.loadStoredResponses === 'function') {
            window.loadStoredResponses();
          }
        } else {
          contentId = `${tabId}Tab`;
        }
        
        // Show the content
        const contentElement = document.getElementById(contentId);
        if (contentElement) {
          contentElement.classList.add('active');
          
          // Update page title
          document.getElementById('currentPageTitle').textContent = tabId.charAt(0).toUpperCase() + tabId.slice(1).replace(/-/g, ' ');
          
          // Load data based on the tab
          if (tabId === 'dashboard') {
            loadDashboard();
          } else if (tabId === 'users') {
            loadUsers();
          } else if (tabId === 'undefined-queries') {
            loadUndefinedQueries('pending');
            // Mark notifications as read
            if (typeof window.markNotificationsAsRead === 'function') {
              window.markNotificationsAsRead();
            }
          } else if (tabId === 'chats' && typeof loadChats === 'function') {
            loadChats();
          }
        } else {
          console.error(`Content element not found for tab: ${tabId}, contentId: ${contentId}`);
        }
      }
    });
    
    // Function to load dashboard statistics
    function loadDashboard() {
      console.log('Loading dashboard statistics...');
      
      // Set loading states
      document.getElementById('totalUsersCount').textContent = '...';
      document.getElementById('totalChats').textContent = '...';
      document.getElementById('totalMessages').textContent = '...';
      document.getElementById('newUsers').textContent = '...';
      
      // Fetch real data from API
      fetch('/api/admin/dashboard-stats')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch dashboard statistics');
          }
          return response.json();
        })
        .then(data => {
          // Update statistics with real data
          document.getElementById('totalUsersCount').textContent = data.totalUsers || '0';
          document.getElementById('totalChats').textContent = data.totalChats || '0';
          document.getElementById('totalMessages').textContent = data.totalMessages || '0';
          document.getElementById('newUsers').textContent = data.newUsers || '0';
          
          // Create or update badges for pending queries
          const pendingBadge = document.querySelector('#undefined-queries-badge');
          if (pendingBadge && data.pendingQueries > 0) {
            pendingBadge.textContent = data.pendingQueries;
            pendingBadge.style.display = 'inline-block';
          }
        })
        .catch(error => {
          console.error('Error loading dashboard statistics:', error);
          
          // Fall back to mock data on error
          document.getElementById('totalUsersCount').textContent = '42';
          document.getElementById('totalChats').textContent = '156';
          document.getElementById('totalMessages').textContent = '1,247';
          document.getElementById('newUsers').textContent = '8';
        });
      
      // Create mock charts for visualization
      if (typeof Chart !== 'undefined') {
        // Messages per day chart
        const messagesCtx = document.getElementById('messagesChart');
        if (messagesCtx) {
          const messagesChart = new Chart(messagesCtx, {
            type: 'line',
            data: {
              labels: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'],
              datasets: [{
                label: 'Messages',
                data: [65, 59, 80, 81, 56, 55, 40],
                fill: false,
                borderColor: '#7c3aed',
                tension: 0.1,
                backgroundColor: '#7c3aed'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.7)'
                  }
                },
                x: {
                  grid: {
                    color: 'rgba(255, 255, 255, 0.1)'
                  },
                  ticks: {
                    color: 'rgba(255, 255, 255, 0.7)'
                  }
                }
              }
            }
          });
        }
        
        // Message distribution chart
        const distributionCtx = document.getElementById('messageDistributionChart');
        if (distributionCtx) {
          const distributionChart = new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
              labels: ['User Messages', 'AI Responses', 'System Messages'],
              datasets: [{
                data: [55, 40, 5],
                backgroundColor: ['#7c3aed', '#3b82f6', '#ef4444'],
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: {
                    color: 'rgba(255, 255, 255, 0.7)',
                    padding: 20
                  }
                }
              }
            }
          });
        }
      }
      
      // Refresh the notification count
      fetchNotificationCount();
    }
    
    // Function to load chat logs
    function loadChats() {
      console.log('Loading chat logs...');
      const chatsTab = document.getElementById('chatsTab');
      
      if (!chatsTab) {
        console.error('Chats tab content container not found');
        return;
      }
      
      // Show loading spinner
      chatsTab.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      `;
      
      // Fetch chat logs from API
      fetch('/api/admin/chat/logs')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch chat logs');
          }
          return response.json();
        })
        .then(data => {
          if (data.chats && data.chats.length > 0) {
            // Create container for chat logs
            let html = `
              <h3 class="mb-4">Chat Logs</h3>
              <div class="data-table-container">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Chat Name</th>
                      <th>Messages</th>
                      <th>Created</th>
                      <th>Last Updated</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            // Add chat rows
            data.chats.forEach(chat => {
              html += `
                <tr>
                  <td>${chat.username || 'Anonymous'}</td>
                  <td>${chat.title || `Chat #${chat.id}`}</td>
                  <td>${chat.message_count || 0}</td>
                  <td>${new Date(chat.created_at).toLocaleString()}</td>
                  <td>${new Date(chat.updated_at).toLocaleString()}</td>
                  <td class="table-actions">
                    <button class="action-btn view" data-chat-id="${chat.id}" title="View chat">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn delete" data-chat-id="${chat.id}" 
                      data-chat-title="${chat.title || `Chat #${chat.id}`}" title="Delete chat">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              `;
            });
            
            // Close table
            html += `
                  </tbody>
                </table>
              </div>
            `;
            
            // Update tab content
            chatsTab.innerHTML = html;
            
            // Add event listeners for action buttons
            document.querySelectorAll('#chatsTab .action-btn.view').forEach(btn => {
              btn.addEventListener('click', function() {
                const chatId = this.getAttribute('data-chat-id');
                viewChatDetails(chatId);
              });
            });
            
            document.querySelectorAll('#chatsTab .action-btn.delete').forEach(btn => {
              btn.addEventListener('click', function() {
                const chatId = this.getAttribute('data-chat-id');
                const chatTitle = this.getAttribute('data-chat-title');
                deleteChatConfirmation(chatId, chatTitle);
              });
            });
            
          } else {
            chatsTab.innerHTML = `
              <h3 class="mb-4">Chat Logs</h3>
              <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p class="empty-state-text">No chat logs found</p>
                <p class="empty-state-subtext">Chat logs will appear here once users start conversations</p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading chat logs:', error);
          chatsTab.innerHTML = `
            <h3 class="mb-4">Chat Logs</h3>
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Error loading chat logs: ${error.message}
            </div>
          `;
        });
    }
    
    // Helper functions for chat management
    function viewChatDetails(chatId) {
      console.log(`Viewing chat details for chat ID: ${chatId}`);
      
      // Get modal elements
      const modal = document.getElementById('chatDetailsModal') || createChatDetailsModal();
      const modalTitle = document.getElementById('chatDetailsTitle');
      const modalContent = document.getElementById('chatDetailsContent');
      const closeBtn = document.getElementById('closeChatDetails');
      
      // Set loading state
      modalTitle.textContent = 'Loading Chat...';
      modalContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
      
      // Show the modal
      modal.classList.add('active');
      
      // Fetch chat messages
      fetch(`/api/admin/chat/${chatId}/messages`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch chat messages');
          }
          return response.json();
        })
        .then(data => {
          // Update modal title
          const chatName = data.chat.chat_name || `Chat #${data.chat.id}`;
          const username = data.chat.username || 'Anonymous';
          modalTitle.textContent = `${chatName} (${username})`;
          
          // If no messages, show empty state
          if (!data.messages || data.messages.length === 0) {
            modalContent.innerHTML = `
              <div class="empty-state">
                <i class="fas fa-comment-slash"></i>
                <p class="empty-state-text">No messages in this chat</p>
              </div>
            `;
            return;
          }
          
          // Create chat messages container
          let html = '<div class="chat-messages-container">';
          
          // Add each message
          data.messages.forEach(msg => {
            const isUser = msg.sender === 'user';
            const messageClass = isUser ? 'user-message' : 'bot-message';
            const messageTime = new Date(msg.created_at).toLocaleString();
            
            html += `
              <div class="chat-message ${messageClass}">
                <div class="message-header">
                  <span class="message-sender">${isUser ? username : 'Bot'}</span>
                  <span class="message-time">${messageTime}</span>
                </div>
                <div class="message-content">${msg.message}</div>
              </div>
            `;
          });
          
          html += '</div>';
          modalContent.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading chat messages:', error);
          modalContent.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Error loading chat messages: ${error.message}
            </div>
          `;
        });
      
      // Add close event handler if not already added
      if (!closeBtn.hasListener) {
        closeBtn.addEventListener('click', () => {
          modal.classList.remove('active');
        });
        closeBtn.hasListener = true;
      }
    }
    
    // Helper function to create chat details modal if it doesn't exist
    function createChatDetailsModal() {
      const modalHtml = `
        <div id="chatDetailsModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="chatDetailsTitle">Chat Details</h3>
              <button id="closeChatDetails" class="close-btn">&times;</button>
            </div>
            <div id="chatDetailsContent" class="modal-body">
              <!-- Chat messages will be loaded here -->
            </div>
            <div class="modal-footer">
              <button id="chatDetailsDone" class="btn btn-secondary">Close</button>
            </div>
          </div>
        </div>
      `;
      
      // Append modal to body
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Add event listener for done button
      document.getElementById('chatDetailsDone').addEventListener('click', () => {
        document.getElementById('chatDetailsModal').classList.remove('active');
      });
      
      return document.getElementById('chatDetailsModal');
    }
    
    function deleteChatConfirmation(chatId, chatTitle) {
      console.log(`Delete confirmation for chat: ${chatTitle} (${chatId})`);
      if (confirm(`Are you sure you want to delete "${chatTitle}"? This action cannot be undone.`)) {
        // Send delete request
        fetch(`/api/admin/chat/${chatId}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete chat');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Reload chats
              loadChats();
              alert(`Chat "${chatTitle}" has been deleted successfully.`);
            } else {
              throw new Error(data.message || 'Failed to delete chat');
            }
          })
          .catch(error => {
            console.error('Error deleting chat:', error);
            alert(`Error: ${error.message}`);
          });
      }
    }
    
    // Function to load user data
    function loadUsers() {
      console.log('Loading user data...');
      const tableBody = document.getElementById('usersTableBody');
      
      if (!tableBody) {
        console.error('Users table body not found');
        return;
      }
      
      tableBody.innerHTML = `
        <tr>
          <td colspan="5">
            <div class="loading-spinner">
              <div class="spinner"></div>
            </div>
          </td>
        </tr>
      `;
      
      // Fetch users from API
      fetch('/api/admin/users')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch users');
          }
          return response.json();
        })
        .then(data => {
          if (data.users && data.users.length > 0) {
            tableBody.innerHTML = '';
            
            // Update the dashboard total users count
            const totalUsersCount = document.getElementById('totalUsersCount');
            if (totalUsersCount) {
              totalUsersCount.textContent = data.users.length;
            }
            
            data.users.forEach(user => {
              const row = document.createElement('tr');
              
              // Username cell
              const usernameCell = document.createElement('td');
              usernameCell.textContent = user.username;
              row.appendChild(usernameCell);
              
              // Email cell
              const emailCell = document.createElement('td');
              emailCell.textContent = user.email || 'N/A';
              row.appendChild(emailCell);
              
              // Role cell
              const roleCell = document.createElement('td');
              const roleBadge = document.createElement('span');
              roleBadge.className = `status-badge ${user.is_admin ? 'admin' : 'user'}`;
              roleBadge.textContent = user.is_admin ? 'Admin' : 'User';
              roleCell.appendChild(roleBadge);
              row.appendChild(roleCell);
              
              // Date cell
              const dateCell = document.createElement('td');
              dateCell.textContent = new Date(user.created_at).toLocaleString();
              row.appendChild(dateCell);
              
              // Actions cell
              const actionsCell = document.createElement('td');
              actionsCell.className = 'table-actions';
              
              // View button
              const viewBtn = document.createElement('button');
              viewBtn.className = 'action-btn view';
              viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
              viewBtn.setAttribute('data-user-id', user.id);
              viewBtn.title = 'View user details';
              actionsCell.appendChild(viewBtn);
              
              // Toggle role button
              const toggleRoleBtn = document.createElement('button');
              toggleRoleBtn.className = 'action-btn edit';
              toggleRoleBtn.innerHTML = '<i class="fas fa-user-shield"></i>';
              toggleRoleBtn.setAttribute('data-user-id', user.id);
              toggleRoleBtn.setAttribute('data-username', user.username);
              toggleRoleBtn.setAttribute('data-is-admin', user.is_admin);
              toggleRoleBtn.title = user.is_admin ? 'Remove admin privileges' : 'Make admin';
              actionsCell.appendChild(toggleRoleBtn);
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.className = 'action-btn delete';
              deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
              deleteBtn.setAttribute('data-user-id', user.id);
              deleteBtn.setAttribute('data-username', user.username);
              deleteBtn.title = 'Delete user';
              actionsCell.appendChild(deleteBtn);
              
              row.appendChild(actionsCell);
              
              tableBody.appendChild(row);
            });
            
            // Add event listeners for action buttons
            document.querySelectorAll('.action-btn.view').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                // Call function to show user details modal
                showUserDetails(userId);
              });
            });
            
            document.querySelectorAll('.action-btn.edit').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                const isAdmin = this.getAttribute('data-is-admin') === 'true';
                // Call function to show toggle admin modal
                showToggleAdminModal(userId, username, isAdmin);
              });
            });
            
            document.querySelectorAll('.action-btn.delete').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = this.getAttribute('data-user-id');
                const username = this.getAttribute('data-username');
                // Call function to show delete user modal
                showDeleteUserModal(userId, username);
              });
            });
            
          } else {
            tableBody.innerHTML = `
              <tr>
                <td colspan="5" class="text-center">No users found</td>
              </tr>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading users:', error);
          tableBody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-danger">
                Error loading users: ${error.message}
              </td>
            </tr>
          `;
        });
    }
    
    // Function to show user details modal
    function showUserDetails(userId) {
      console.log(`Showing details for user ID: ${userId}`);
      
      // Get modal elements
      const modal = document.getElementById('userDetailsModal');
      const closeBtn = document.getElementById('closeUserDetails');
      const doneBtn = document.getElementById('userDetailsDone');
      
      // Set loading state
      document.getElementById('detailUsername').textContent = 'Loading...';
      document.getElementById('detailEmail').textContent = 'Loading...';
      document.getElementById('detailRole').textContent = 'Loading...';
      document.getElementById('detailCreated').textContent = 'Loading...';
      document.getElementById('userChatsTableBody').innerHTML = '<tr><td colspan="4">Loading user chats...</td></tr>';
      
      // Show the modal
      modal.classList.add('active');
      
      // Fetch user details
      fetch(`/api/admin/users/${userId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch user details');
          }
          return response.json();
        })
        .then(data => {
          // Update user details
          document.getElementById('detailUsername').textContent = data.user.username;
          document.getElementById('detailEmail').textContent = data.user.email || 'N/A';
          document.getElementById('detailRole').textContent = data.user.is_admin ? 'Admin' : 'User';
          document.getElementById('detailCreated').textContent = new Date(data.user.created_at).toLocaleString();
          
          // Update user chats
          const chatsTableBody = document.getElementById('userChatsTableBody');
          
          if (data.chats && data.chats.length > 0) {
            chatsTableBody.innerHTML = '';
            
            data.chats.forEach(chat => {
              const row = document.createElement('tr');
              
              // Chat name cell
              const nameCell = document.createElement('td');
              nameCell.textContent = chat.title || `Chat #${chat.id}`;
              row.appendChild(nameCell);
              
              // Messages count cell
              const messagesCell = document.createElement('td');
              messagesCell.textContent = chat.message_count || 0;
              row.appendChild(messagesCell);
              
              // Last updated cell
              const updatedCell = document.createElement('td');
              updatedCell.textContent = new Date(chat.updated_at).toLocaleString();
              row.appendChild(updatedCell);
              
              // Actions cell
              const actionsCell = document.createElement('td');
              
              const viewChatBtn = document.createElement('button');
              viewChatBtn.className = 'action-btn view';
              viewChatBtn.innerHTML = '<i class="fas fa-comments"></i>';
              viewChatBtn.setAttribute('data-chat-id', chat.id);
              viewChatBtn.title = 'View chat';
              actionsCell.appendChild(viewChatBtn);
              
              row.appendChild(actionsCell);
              
              chatsTableBody.appendChild(row);
            });
            
          } else {
            chatsTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No chats found for this user</td></tr>';
          }
        })
        .catch(error => {
          console.error('Error fetching user details:', error);
          
          // Show error message
          document.getElementById('userChatsTableBody').innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-danger">
                Error loading user details: ${error.message}
              </td>
            </tr>
          `;
        });
      
      // Add event listeners for close buttons
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      doneBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
    }
    
    // Function to show toggle admin modal
    function showToggleAdminModal(userId, username, isAdmin) {
      console.log(`Showing toggle admin modal for user: ${username} (${userId}), current status: ${isAdmin ? 'Admin' : 'User'}`);
      
      // Get modal elements
      const modal = document.getElementById('toggleAdminModal');
      const closeBtn = document.getElementById('closeToggleAdmin');
      const cancelBtn = document.getElementById('cancelToggleAdmin');
      const confirmBtn = document.getElementById('confirmToggleAdmin');
      
      // Update modal content
      const title = document.getElementById('toggleAdminTitle');
      const message = document.getElementById('toggleAdminMessage');
      
      title.textContent = isAdmin ? 'Remove Admin Role' : 'Grant Admin Role';
      message.textContent = isAdmin ? 
        `Are you sure you want to remove admin privileges from ${username}?` : 
        `Are you sure you want to grant admin privileges to ${username}?`;
      
      // Show the modal
      modal.classList.add('active');
      
      // Remove any existing event listeners using cloning
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      
      // Add event listener for confirm button
      newConfirmBtn.addEventListener('click', () => {
        // Show loading state
        newConfirmBtn.disabled = true;
        newConfirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Send request to toggle admin status
        fetch(`/api/admin/users/${userId}/toggle-admin`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to update user role');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Hide modal
              modal.classList.remove('active');
              
              // Reload users table
              loadUsers();
              
              // Show success message
              alert(`User role updated successfully. ${username} is now a ${isAdmin ? 'regular user' : 'admin'}.`);
            } else {
              throw new Error(data.message || 'Failed to update user role');
            }
          })
          .catch(error => {
            console.error('Error updating user role:', error);
            alert(`Error: ${error.message}`);
            
            // Reset button state
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = 'Change Role';
          });
      });
      
      // Add event listeners for close/cancel buttons
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
    }
    
    // Function to show delete user modal
    function showDeleteUserModal(userId, username) {
      console.log(`Showing delete modal for user: ${username} (${userId})`);
      
      // Get modal elements
      const modal = document.getElementById('deleteUserModal');
      const closeBtn = document.getElementById('closeDeleteUser');
      const cancelBtn = document.getElementById('cancelDeleteUser');
      const confirmBtn = document.getElementById('confirmDeleteUser');
      const usernameElement = document.getElementById('deleteUsername');
      
      // Update username in modal
      usernameElement.textContent = username;
      
      // Show the modal
      modal.classList.add('active');
      
      // Remove any existing event listeners using cloning
      const newConfirmBtn = confirmBtn.cloneNode(true);
      confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
      
      // Add event listener for confirm button
      newConfirmBtn.addEventListener('click', () => {
        // Show loading state
        newConfirmBtn.disabled = true;
        newConfirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Send request to delete user
        fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to delete user');
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              // Hide modal
              modal.classList.remove('active');
              
              // Reload users table
              loadUsers();
              
              // Show success message
              alert(`User ${username} has been deleted successfully.`);
            } else {
              throw new Error(data.message || 'Failed to delete user');
            }
          })
          .catch(error => {
            console.error('Error deleting user:', error);
            alert(`Error: ${error.message}`);
            
            // Reset button state
            newConfirmBtn.disabled = false;
            newConfirmBtn.textContent = 'Delete User';
          });
      });
      
      // Add event listeners for close/cancel buttons
      closeBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
      
      cancelBtn.addEventListener('click', () => {
        modal.classList.remove('active');
      });
    }
  </script>

  <!-- JavaScript to load and handle undefined queries -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Load undefined queries when tab is clicked
      const tabItems = document.querySelectorAll('.tab-item');
      tabItems.forEach(item => {
        item.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          
          // Hide all tab contents
          const tabContents = document.querySelectorAll('.tab-content');
          tabContents.forEach(content => {
            content.style.display = 'none';
          });
          
          // Remove active class from all tabs
          tabItems.forEach(tab => {
            tab.classList.remove('active');
          });
          
          // Show selected tab content and add active class to tab
          this.classList.add('active');
          
          // Handle special case for undefined-queries tab
          if (tabName === 'undefined-queries') {
            document.getElementById('undefined-queries-content').style.display = 'block';
            loadUndefinedQueries('pending'); // Load pending queries by default
          } else {
            // Show the tab content with the corresponding id
            const targetContent = document.getElementById(tabName + 'Tab') || 
                                 document.getElementById(tabName + '-content');
            if (targetContent) {
              targetContent.style.display = 'block';
            }
          }
        });
      });
      
      // Load undefined queries
      async function loadUndefinedQueries(status = 'pending') {
        try {
          const tableBody = document.getElementById('undefined-queries-table');
          tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Loading queries...</td></tr>';
          
          const response = await fetch(`/api/admin/undefined-queries?status=${status}`);
          if (!response.ok) {
            throw new Error('Failed to load undefined queries');
          }
          
          const data = await response.json();
          
          if (data.queries && data.queries.length > 0) {
            tableBody.innerHTML = '';
            
            data.queries.forEach(query => {
              const tr = document.createElement('tr');
              
              // Format date
              const created = new Date(query.created_at);
              const formattedDate = created.toLocaleDateString() + ' ' + created.toLocaleTimeString();
              
              // AI status badge
              let aiStatusBadge = '<span class="badge bg-secondary">Not analyzed</span>';
              if (query.ai_analyzed) {
                aiStatusBadge = query.ai_data_found ? 
                  '<span class="badge bg-success">Data found</span>' : 
                  '<span class="badge bg-danger">No data</span>';
              }
              
              tr.innerHTML = `
                <td>${query.id}</td>
                <td>${query.query.substring(0, 100)}${query.query.length > 100 ? '...' : ''}</td>
                <td>${query.username || 'Anonymous'}</td>
                <td>${formattedDate}</td>
                <td>${aiStatusBadge}</td>
                <td>
                  <button class="btn btn-sm btn-primary view-query" data-id="${query.id}">
                    <i class="fas fa-eye"></i>
                  </button>
                  ${status === 'pending' ? `
                    <button class="btn btn-sm btn-success approve-query" data-id="${query.id}">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger reject-query" data-id="${query.id}">
                      <i class="fas fa-times"></i>
                    </button>
                  ` : ''}
                  ${status === 'approved' ? `
                    <button class="btn btn-sm btn-warning edit-response" data-id="${query.id}">
                      <i class="fas fa-edit"></i>
                    </button>
                  ` : ''}
                </td>
              `;
              
              tableBody.appendChild(tr);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-query').forEach(btn => {
              btn.addEventListener('click', function() {
                const queryId = this.getAttribute('data-id');
                openQueryResponseModal(queryId);
              });
            });
            
            document.querySelectorAll('.approve-query').forEach(btn => {
              btn.addEventListener('click', function() {
                const queryId = this.getAttribute('data-id');
                showApproveQueryModal(queryId);
              });
            });
            
            document.querySelectorAll('.reject-query').forEach(btn => {
              btn.addEventListener('click', function() {
                const queryId = this.getAttribute('data-id');
                rejectQuery(queryId);
              });
            });
            
            document.querySelectorAll('.edit-response').forEach(btn => {
              btn.addEventListener('click', function() {
                const queryId = this.getAttribute('data-id');
                openQueryResponseModal(queryId);
              });
            });
          } else {
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center">No ${status} queries found</td></tr>`;
          }
        } catch (error) {
          console.error('Error loading undefined queries:', error);
          document.getElementById('undefined-queries-table').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">Error loading queries</td></tr>';
        }
      }
      
      // Function to open query response modal
      async function openQueryResponseModal(queryId) {
        try {
          const response = await fetch(`/api/admin/undefined-query/${queryId}`);
          if (!response.ok) {
            throw new Error('Failed to load query details');
          }
          
          const data = await response.json();
          
          // Populate modal with query details
          document.getElementById('currentQueryId').value = data.id;
          document.getElementById('queryText').textContent = data.query;
          document.getElementById('queryResponse').value = data.response || '';
          
          // Set status radio button
          document.querySelector(`input[name="queryStatus"][value="${data.status}"]`).checked = true;
          
          // Update AI analysis section
          if (data.ai_analyzed) {
            document.getElementById('aiDataStatus').className = data.ai_data_found ? 
              'badge bg-success' : 'badge bg-danger';
            document.getElementById('aiDataStatus').textContent = data.ai_data_found ? 
              'Data found' : 'No data found';
            
            document.getElementById('aiAnalysisDetails').textContent = data.ai_data_details || 
              'No detailed information available';
          } else {
            document.getElementById('aiDataStatus').className = 'badge bg-secondary';
            document.getElementById('aiDataStatus').textContent = 'Not analyzed';
            document.getElementById('aiAnalysisDetails').textContent = 'No AI analysis has been performed';
          }
          
          // Show the modal
          new bootstrap.Modal(document.getElementById('queryResponseModal')).show();
        } catch (error) {
          console.error('Error loading query details:', error);
          alert('Failed to load query details. Please try again.');
        }
      }
      
      // Function to show approve query modal
      function showApproveQueryModal(queryId) {
        // Set the current query ID
        document.getElementById('currentQueryId').value = queryId;
        
        // Set status to approved
        document.getElementById('statusApproved').checked = true;
        
        // Open the modal
        openQueryResponseModal(queryId);
      }
      
      // Function to reject a query
      async function rejectQuery(queryId) {
        if (confirm('Are you sure you want to reject this query?')) {
          try {
            const response = await fetch(`/api/admin/undefined-query/${queryId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                status: 'rejected'
              })
            });
            
            if (!response.ok) {
              throw new Error('Failed to reject query');
            }
            
            // Reload queries
            loadUndefinedQueries('pending');
          } catch (error) {
            console.error('Error rejecting query:', error);
            alert('Failed to reject query. Please try again.');
          }
        }
      }
      
      // Add event listeners to filter buttons
      document.getElementById('filter-pending').addEventListener('click', function() {
        document.getElementById('filter-pending').classList.add('active');
        document.getElementById('filter-approved').classList.remove('active');
        document.getElementById('filter-rejected').classList.remove('active');
        loadUndefinedQueries('pending');
      });
      
      document.getElementById('filter-approved').addEventListener('click', function() {
        document.getElementById('filter-pending').classList.remove('active');
        document.getElementById('filter-approved').classList.add('active');
        document.getElementById('filter-rejected').classList.remove('active');
        loadUndefinedQueries('approved');
      });
      
      document.getElementById('filter-rejected').addEventListener('click', function() {
        document.getElementById('filter-pending').classList.remove('active');
        document.getElementById('filter-approved').classList.remove('active');
        document.getElementById('filter-rejected').classList.add('active');
        loadUndefinedQueries('rejected');
      });
      
      // Save query response
      document.getElementById('saveQueryResponse').addEventListener('click', async function() {
        const queryId = document.getElementById('currentQueryId').value;
        const response = document.getElementById('queryResponse').value;
        const status = document.querySelector('input[name="queryStatus"]:checked').value;
        const runAiAnalysis = document.getElementById('runAiAnalysis').checked;
        
        try {
          const apiResponse = await fetch(`/api/admin/undefined-query/${queryId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              response,
              status,
              run_ai_analysis: runAiAnalysis
            })
          });
          
          if (!apiResponse.ok) {
            throw new Error('Failed to update query');
          }
          
          // Hide the modal
          bootstrap.Modal.getInstance(document.getElementById('queryResponseModal')).hide();
          
          // Show success message
          alert('Query response saved successfully');
          
          // Reload queries
          loadUndefinedQueries(status);
        } catch (error) {
          console.error('Error saving query response:', error);
          alert('Failed to save query response. Please try again.');
        }
      });
      
      // Default to first tab (dashboard) on page load
      document.querySelector('.tab-item').click();
    });
  </script>

  <!-- Add click handler for 'View All Users' link -->
  <script>
    document.getElementById('viewUsersLink').addEventListener('click', function(e) {
      e.preventDefault();
      // Find the Users tab and click it
      const usersTab = document.querySelector('.tab-item[data-tab="users"]');
      if (usersTab) {
        usersTab.click();
      }
    });
  </script>
</body>
</html> 